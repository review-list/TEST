<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>{{ site_name }} - æ¤œç´¢</title>
  <meta name="description" content="ä½œå“æ¤œç´¢ãƒšãƒ¼ã‚¸ã§ã™ã€‚" />

  {% if css_path %}
    <link rel="stylesheet" href="{{ css_path }}">
  {% endif %}

  <style>
        :root{color-scheme:dark;}
/* æ¤œç´¢ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼šå…±é€šCSSï¼ˆdocs/assets/style.cssï¼‰ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
    .controls{margin:14px 0 16px; display:grid; gap:10px;}
    .controls .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .controls input[type="search"], .controls select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      color-scheme:dark;
      min-width:220px;
      outline:none;
    }
    .controls input[type="search"]::placeholder{color:rgba(148,163,184,.9)}
    .controls button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .controls button:hover{border-color:rgba(96,165,250,.55)}
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      user-select:none;
    }
    .toggle:hover{border-color:rgba(96,165,250,.55)}
    .toggle.active{
      border-color:rgba(96,165,250,.75);
      background:rgba(96,165,250,.22);
      color:#dbeafe;
    }
    .toggle input{accent-color:var(--accent);}

    .controls select option, .controls select optgroup{
      background:#0b1220;
      color:var(--text);
    }

    .count{color:var(--muted); font-size:14px; margin-left:auto;}

    .hint{color:var(--muted); font-size:13px;}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04);}

    .top-tags{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0;}
    .top-tags button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      font-weight:800;
    }
    .top-tags button:hover{border-color:rgba(96,165,250,.55)}
    .top-tags button.active{
      border-color:rgba(96,165,250,.75);
      background:rgba(96,165,250,.22);
      color:#dbeafe;
    }

    .selected-tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .tag-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(96,165,250,.4);
      background:rgba(96,165,250,.12);
      color:#dbeafe;
      font-size:12px;
      font-weight:800;
    }
    .tag-chip .x{
      width:18px; height:18px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      line-height:1;
    }
    .tag-chip .x:hover{border-color:rgba(255,255,255,.32)}

    .loadmore-wrap{display:flex; justify-content:center; margin:14px 0 24px;}
    .status{color:var(--muted); font-size:13px; margin-top:6px;}
    .sentinel{height:1px;}
  </style>

  <meta name="robots" content="noindex,follow" />
  {% if canonical_url %}<link rel="canonical" href="{{ canonical_url }}" />{% endif %}
  <meta property="og:site_name" content="{{ site_name }}" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="{{ site_name }} - æ¤œç´¢" />
  <meta property="og:description" content="ä½œå“æ¤œç´¢ãƒšãƒ¼ã‚¸ã§ã™ã€‚" />
  {% if canonical_url %}<meta property="og:url" content="{{ canonical_url }}" />{% endif %}
    <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ site_name }} - æ¤œç´¢" />
  <meta name="twitter:description" content="ä½œå“æ¤œç´¢ãƒšãƒ¼ã‚¸ã§ã™ã€‚" />
  </head>

<body>
  <!-- å…±é€šCSSï¼ˆ.header/.header-inner/.navï¼‰ã«åˆã‚ã›ã¦æ¤œç´¢ãƒšãƒ¼ã‚¸ã‚‚çµ±ä¸€ -->
  <header class="header">
    <div class="container header-inner">
      <div class="brand">
        <a href="{{ home_href or '../' }}"><strong>{{ site_name }}</strong></a>
      </div>
      <nav class="nav">
        <a href="{{ home_href or '../' }}">ãƒ›ãƒ¼ãƒ </a>
        <a href="{{ actresses_href or '../actresses/' }}">å¥³å„ª</a>
        <a href="{{ genres_href or '../genres/' }}">ã‚¸ãƒ£ãƒ³ãƒ«</a>
        <a href="{{ search_href or '../search/' }}">æ¤œç´¢</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 style="margin:16px 0 8px;">æ¤œç´¢</h1>

    <section class="controls" aria-label="æ¤œç´¢ã¨çµã‚Šè¾¼ã¿">
      <div class="row">
        <input id="q" type="search" placeholder="ã‚¿ã‚¤ãƒˆãƒ« / å¥³å„ª / ã‚¿ã‚°ã§æ¤œç´¢" autocomplete="off">

        <select id="actress">
          <option value="">å¥³å„ªï¼ˆã™ã¹ã¦ï¼‰</option>
        </select>

        <select id="sort">
          <option value="new">æ–°ç€é †</option>
          <option value="old">å¤ã„é †</option>
          <option value="title">ã‚¿ã‚¤ãƒˆãƒ«é †</option>
        </select>

        <select id="mode">
          <option value="or">ã‚¿ã‚° ORï¼ˆã©ã‚Œã‹å«ã‚€ï¼‰</option>
          <option value="and">ã‚¿ã‚° ANDï¼ˆå…¨éƒ¨å«ã‚€ï¼‰</option>
        </select>

        <label class="toggle" id="tOnlyImg"><input id="onlyImg" type="checkbox">ğŸ–¼ï¸ ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚ã‚Š</label>
        <label class="toggle" id="tOnlyMov"><input id="onlyMov" type="checkbox">ğŸ¬ ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»ã‚ã‚Š</label>


        <button id="reset" type="button">ãƒªã‚»ãƒƒãƒˆ</button>

        <div class="count">
          <span id="shown">0</span> / <span id="total">0</span> ä»¶
        </div>
      </div>

      <div class="row" style="align-items:flex-start;">
        <div>
          <div class="pill">äººæ°—ã‚¿ã‚°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ON/OFFï¼‰</div>
          <div class="top-tags" id="topTags"></div>
          <div class="selected-tags" id="selectedTags" aria-label="é¸æŠä¸­ã‚¿ã‚°"></div>
          <div class="status" id="loadStatus"></div>
        </div>
      </div>

      <div class="row">
        <div class="pill">ã‚¿ã‚°è¿½åŠ ï¼ˆEnterã§è¿½åŠ  / Ã—ã§è§£é™¤ï¼‰</div>
        <input id="tagInput" type="search" placeholder="ã‚¿ã‚°åã‚’å…¥åŠ›" list="tagOptions" autocomplete="off">
        <datalist id="tagOptions"></datalist>
        <div class="hint">
          çŠ¶æ…‹ã¯URLã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå…±æœ‰ã§ãã¾ã™ï¼‰<br>
          â€»å¤§é‡æ™‚ã¯åˆ†å‰²JSONã‚’é †æ¬¡èª­ã¿è¾¼ã¿ãªãŒã‚‰æ¤œç´¢ã—ã¾ã™
        </div>
      </div>
    </section>

    <section class="grid" id="results"></section>

    <div class="loadmore-wrap">
      <button id="loadMore" type="button">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>
    </div>
    <div class="sentinel" id="sentinel"></div>

    <footer class="footer" style="margin:22px 0 30px; color:var(--muted); text-align:center;">
      Â© 2026 {{ site_name }}
    </footer>
  </main>

  <script>
    (function(){
      // äº’æ›ï¼šmanifestãŒãªã‘ã‚Œã°å˜ä¸€JSONã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const MANIFEST_URL = "../assets/works_index_manifest.json";
      const FALLBACK_DATA_URL = "{{ data_url }}"; // build.pyã®renderãŒæ¸¡ã—ã¦ã‚‹URLï¼ˆä¾‹: ../assets/works_index.jsonï¼‰

      const q = document.getElementById("q");
      const actress = document.getElementById("actress");
      const tagInput = document.getElementById("tagInput");
      const tagOptions = document.getElementById("tagOptions");
      const selectedTagsEl = document.getElementById("selectedTags");
      const mode = document.getElementById("mode");
      const sort = document.getElementById("sort");
      const onlyImg = document.getElementById("onlyImg");
      const onlyMov = document.getElementById("onlyMov");
      const tOnlyImg = document.getElementById("tOnlyImg");
      const tOnlyMov = document.getElementById("tOnlyMov");
      const reset = document.getElementById("reset");

      const results = document.getElementById("results");
      const shownEl = document.getElementById("shown");
      const totalEl = document.getElementById("total");

      const topTagsEl = document.getElementById("topTags");
      const loadStatusEl = document.getElementById("loadStatus");

      const loadMoreBtn = document.getElementById("loadMore");
      const sentinel = document.getElementById("sentinel");

      const PER_BATCH = 24; // 1å›ã«è¿½åŠ è¡¨ç¤ºã™ã‚‹ä»¶æ•°ï¼ˆç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å˜ä½ï¼‰

      let manifest = null;
      let all = [];              // èª­ã¿è¾¼ã‚ãŸåˆ†ã ã‘å…¥ã‚‹ï¼ˆåˆ†å‰²ãªã‚‰æ®µéšçš„ã«å¢—ãˆã‚‹ï¼‰
      let filtered = [];
      let renderCount = 0;       // ä»Šè¡¨ç¤ºã—ã¦ã‚‹ä»¶æ•°ï¼ˆfilteredå…ˆé ­ã‹ã‚‰ï¼‰
      let loadingChunks = false;

      // ã‚¿ã‚°å€™è£œã¨é¸æŠçŠ¶æ…‹
      let allTagsList = [];
      let tagLookup = new Map(); // norm(tag) -> åŸæ–‡
      let selectedTags = [];     // åŸæ–‡ã®é…åˆ—ï¼ˆURLã«ã‚‚ã“ã‚Œã‚’å…¥ã‚Œã‚‹ï¼‰

      function norm(s){ return (s||"").toString().trim().toLowerCase(); }
      function uniqSorted(arr){
        return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> a.localeCompare(b, "ja"));
      }
      function escapeHtml(s){
        return (s||"").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function getSelectedValues(selectEl){
        return Array.from(selectEl.selectedOptions).map(o => o.value).filter(Boolean);
      }
      function fillSelect(selectEl, values, firstLabel){
        selectEl.innerHTML = "";
        if (firstLabel !== null){
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = firstLabel;
          selectEl.appendChild(opt);
        }
        for (const v of values){
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          selectEl.appendChild(opt);
        }
      }

      function setAllTags(values){
        allTagsList = Array.from(values || []).filter(Boolean);
        tagLookup = new Map(allTagsList.map(t => [norm(t), t]));

        // datalist ã‚’å†æ§‹ç¯‰
        tagOptions.innerHTML = "";
        for (const t of allTagsList){
          const opt = document.createElement("option");
          opt.value = t;
          tagOptions.appendChild(opt);
        }
      }

      function setSelectedTags(next){
        const uniq = [];
        const seen = new Set();
        for (const t of (next || [])){
          const canon = tagLookup.get(norm(t)) || t;
          if (!canon) continue;
          if (seen.has(canon)) continue;
          seen.add(canon);
          uniq.push(canon);
        }
        selectedTags = uniq;
        renderSelectedTags();
        updateTopTagsActiveState();
      }

      function addTag(tagName){
        const canon = tagLookup.get(norm(tagName)) || tagName;
        if (!canon) return;
        if (selectedTags.includes(canon)) return;
        selectedTags = [...selectedTags, canon];
        renderSelectedTags();
        updateTopTagsActiveState();
      }

      function removeTag(tagName){
        selectedTags = selectedTags.filter(t => t !== tagName);
        renderSelectedTags();
        updateTopTagsActiveState();
      }


      function toggleTag(tagName){
        const canon = tagLookup.get(norm(tagName)) || tagName;
        if (!canon) return;
        if (selectedTags.includes(canon)){
          removeTag(canon);
        }else{
          addTag(canon);
        }
      }

      function renderSelectedTags(){
        selectedTagsEl.innerHTML = "";
        if (!selectedTags.length) return;
        for (const t of selectedTags){
          const chip = document.createElement("span");
          chip.className = "tag-chip";
          chip.innerHTML = `<span>${escapeHtml(t)}</span><span class="x" role="button" aria-label="${escapeHtml(t)} ã‚’è§£é™¤">Ã—</span>`;
          chip.querySelector(".x").addEventListener("click", () => {
            removeTag(t);
            applyFilters({resetRender:true});
          });
          selectedTagsEl.appendChild(chip);
        }
      }

      function updateTopTagsActiveState(){
        const set = new Set(selectedTags.map(norm));
        for (const b of topTagsEl.querySelectorAll("button[data-tag]")){
          const t = b.getAttribute("data-tag") || "";
          b.classList.toggle("active", set.has(norm(t)));
        }
      }


      function updateToggleStyles(){
        if (!tOnlyImg || !tOnlyMov) return;
        tOnlyImg.classList.toggle("active", !!onlyImg.checked);
        tOnlyMov.classList.toggle("active", !!onlyMov.checked);
      }

      // -------------------------
      // URL state
      // -------------------------
      function readStateFromUrl(){
        const u = new URL(location.href);
        return {
          q: u.searchParams.get("q") || "",
          a: u.searchParams.get("a") || "",
          tags: (u.searchParams.get("tags") || "").split(",").filter(Boolean),
          mode: u.searchParams.get("mode") || "or",
          sort: u.searchParams.get("sort") || "new",
          img: u.searchParams.get("img") === "1",
          mov: u.searchParams.get("mov") === "1",
        };
      }

      function writeStateToUrl(){
        const u = new URL(location.href);
        const st = currentState();

        if (st.q) u.searchParams.set("q", st.q); else u.searchParams.delete("q");
        if (st.a) u.searchParams.set("a", st.a); else u.searchParams.delete("a");
        if (st.tags.length) u.searchParams.set("tags", st.tags.join(",")); else u.searchParams.delete("tags");
        if (st.mode && st.mode !== "or") u.searchParams.set("mode", st.mode); else u.searchParams.delete("mode");
        if (st.sort && st.sort !== "new") u.searchParams.set("sort", st.sort); else u.searchParams.delete("sort");

        if (st.img) u.searchParams.set("img", "1"); else u.searchParams.delete("img");
        if (st.mov) u.searchParams.set("mov", "1"); else u.searchParams.delete("mov");

        history.replaceState({}, "", u.toString());
      }

      function applyStateToControls(st){
        q.value = st.q || "";
        actress.value = st.a || "";
        mode.value = st.mode || "or";
        sort.value = st.sort || "new";
        onlyImg.checked = !!st.img;
        onlyMov.checked = !!st.mov;
        updateToggleStyles();

        // tagsï¼ˆURLï¼‰ -> é¸æŠä¸­ã‚¿ã‚°
        setSelectedTags(st.tags || []);
      }

      function currentState(){
        return {
          q: q.value.trim(),
          a: actress.value,
          tags: selectedTags,
          mode: mode.value,
          sort: sort.value,
          img: !!onlyImg.checked,
          mov: !!onlyMov.checked,
        };
      }

      // -------------------------
      // Popular tags
      // -------------------------
      function renderTopTags(topTags){
        topTagsEl.innerHTML = "";
        (topTags || []).slice(0, 30).forEach(x => {
          const b = document.createElement("button");
          b.type = "button";
          b.setAttribute("data-tag", x.name);
          b.textContent = `${x.name} (${x.count})`;
          b.addEventListener("click", () => {
            toggleTag(x.name);
            tagInput.value = "";
            applyFilters({resetRender:true});
          });
          topTagsEl.appendChild(b);
        });
        updateTopTagsActiveState();
      }

      // -------------------------
      // Filter & Sort
      // -------------------------
      function matchTags(itemTagsLower, selectedLower, modeVal){
        if (!selectedLower.length) return true;
        if (modeVal === "and"){
          return selectedLower.every(t => itemTagsLower.includes(t));
        }
        return selectedLower.some(t => itemTagsLower.includes(t));
      }

      function compareBySort(a, b, sortVal){
        if (sortVal === "title"){
          return (a.title||"").localeCompare((b.title||""), "ja");
        }
        if (sortVal === "old"){
          return (a.release_date||"").localeCompare((b.release_date||""), "ja");
        }
        return (b.release_date||"").localeCompare((a.release_date||""), "ja");
      }

      function applyFilters({resetRender=true} = {}){
        const kw = norm(q.value);
        const a = norm(actress.value);
        const selectedLower = selectedTags.map(norm);
        const modeVal = mode.value;
        const sortVal = sort.value;

        filtered = all.filter(x => {
          const title = norm(x.title);
          const as = norm((x.actresses||[]).join(" "));
          const tg = norm((x.tags||[]).join(" "));

          const okKw = !kw || title.includes(kw) || as.includes(kw) || tg.includes(kw);
          const okA  = !a  || as.includes(a);
          const okT  = matchTags(tg, selectedLower, modeVal);

          const okImg = !onlyImg.checked || (Number(x.sample_image_count || 0) > 0);
          const okMov = !onlyMov.checked || !!x.has_sample_movie;

          return okKw && okA && okT && okImg && okMov;
        });

        filtered.sort((x,y)=> compareBySort(x,y,sortVal));

        if (resetRender){
          renderCount = 0;
          results.innerHTML = "";
        }

        writeStateToUrl();
        updateCounters();
        renderMore(); // ã¾ãš1ãƒãƒƒãƒå‡ºã™
      }

      function updateCounters(){
        totalEl.textContent = manifest?.total_items ? String(manifest.total_items) : String(all.length);
        shownEl.textContent = String(filtered.length);
      }

      // -------------------------
      // Render (infinite)
      // -------------------------
      function renderCard(w){
        const card = document.createElement("article");
        card.className = "card";

        const detailHref = `../works/${w.id}/`;
        const img = w.hero_image ? `
          <a href="${detailHref}" style="display:block; text-decoration:none; color:inherit;">
            <img class="thumb" src="${w.hero_image}" alt="${escapeHtml(w.title)}" loading="lazy">
          </a>
        ` : "";
        const date = w.release_date ? `<div class="meta">å…¬é–‹æ—¥ï¼š${escapeHtml(w.release_date)}</div>` : "";
        const actressesHtml = (w.actresses && w.actresses.length)
          ? `<div class="tags">${w.actresses.slice(0,6).map(a=>`<span class="tag">${escapeHtml(a)}</span>`).join("")}</div>`
          : "";
        const tagsHtml = (w.tags && w.tags.length)
          ? `<div class="tags">${w.tags.slice(0,8).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>`
          : "";

        const si = Number(w.sample_image_count || 0);
        const sm = !!w.has_sample_movie;
        const badges = (si || sm)
          ? `<div class="badges" style="margin-top:10px;">
               ${si ? `<span class="badge sm on" title="ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚ã‚Š">ğŸ–¼ï¸ ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚ã‚Š</span>` : ""}
               ${sm ? `<span class="badge sm on" title="ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»ã‚ã‚Š">ğŸ¬ ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»ã‚ã‚Š</span>` : ""}
             </div>`
          : "";
        const actions = `
          <div class="actions">
            <a class="btn secondary" href="${detailHref}">è©³ç´°ã‚’è¦‹ã‚‹</a>
            ${w.official_url ? `<a class="btn" href="${w.official_url}" target="_blank" rel="noopener">å…¬å¼ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</a>` : ""}
          </div>
        `;

        card.innerHTML = `
          ${img}
          <div class="pad">
            <div class="title">
              <a href="${detailHref}" style="color:inherit; text-decoration:none;">
                ${escapeHtml(w.title)}
              </a>
            </div>
            ${date}
            ${actressesHtml}
            ${tagsHtml}
            ${badges}
            ${actions}
          </div>
        `;
        return card;
      }

      function renderMore(){
        const next = filtered.slice(renderCount, renderCount + PER_BATCH);
        for (const w of next){
          results.appendChild(renderCard(w));
        }
        renderCount += next.length;

        // ãƒœã‚¿ãƒ³çŠ¶æ…‹
        const hasMore = renderCount < filtered.length;
        loadMoreBtn.disabled = !hasMore;
        loadMoreBtn.textContent = hasMore ? "ã•ã‚‰ã«èª­ã¿è¾¼ã‚€" : "ã“ã‚Œä»¥ä¸Šã‚ã‚Šã¾ã›ã‚“";
      }

      // IntersectionObserver ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      function setupInfiniteScroll(){
        if (!("IntersectionObserver" in window)) return;

        const io = new IntersectionObserver(entries => {
          const e = entries[0];
          if (e.isIntersecting){
            // ã¾ã è¡¨ç¤ºã§ãã‚‹ãªã‚‰è¿½åŠ 
            if (renderCount < filtered.length){
              renderMore();
            }
          }
        }, {rootMargin: "800px 0px"});
        io.observe(sentinel);
      }

      // -------------------------
      // Load data
      // -------------------------
      async function tryLoadManifest(){
        try{
          const res = await fetch(MANIFEST_URL, {cache:"no-store"});
          if (!res.ok) return null;
          return await res.json();
        }catch{
          return null;
        }
      }

      function setStatus(msg){
        loadStatusEl.textContent = msg || "";
      }

      async function loadAllByManifest(m){
        loadingChunks = true;
        setStatus(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª­è¾¼ä¸­â€¦ 0 / ${m.chunk_files.length}`);

        // ã¾ãšã‚»ãƒ¬ã‚¯ãƒˆã‚’manifestã‹ã‚‰ä½œã‚Œã‚‹ï¼ˆå…¨ä»¶èª­ã¾ãªãã¦ã‚‚OKï¼‰
        fillSelect(actress, m.all_actresses || [], "å¥³å„ªï¼ˆã™ã¹ã¦ï¼‰");
        setAllTags(m.all_tags || []);

        renderTopTags(m.top_tags || []);

        // URLçŠ¶æ…‹åæ˜ ï¼ˆoptionsãŒå…¥ã£ãŸå¾Œã«ï¼‰
        const st = readStateFromUrl();
        applyStateToControls(st);

        // ãƒãƒ£ãƒ³ã‚¯ã‚’é †æ¬¡èª­ã¿è¾¼ã¿ã€‚èª­ã¿è¾¼ã‚€ãŸã³ã«æ¤œç´¢çµæœã‚‚æ›´æ–°ã€‚
        all = [];
        for (let i=0; i<m.chunk_files.length; i++){
          const file = m.chunk_files[i];
          const res = await fetch(`../assets/${file}`, {cache:"no-store"});
          if (!res.ok) throw new Error("ãƒãƒ£ãƒ³ã‚¯å–å¾—å¤±æ•—: " + file);

          const chunk = await res.json();
          all.push(...chunk);

          setStatus(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª­è¾¼ä¸­â€¦ ${i+1} / ${m.chunk_files.length}ï¼ˆ${all.length}ä»¶èª­ã¿è¾¼ã¿æ¸ˆï¼‰`);

          // èª­ã¿è¾¼ã¿é€”ä¸­ã§ã‚‚æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«æ›´æ–°ï¼ˆé‡ããªã‚‰ãªã„ã‚ˆã†æœ€åˆã¯æ§ãˆã‚ã«ï¼‰
          applyFilters({resetRender:true});
        }

        setStatus(`èª­è¾¼å®Œäº†ï¼š${all.length}ä»¶`);
        loadingChunks = false;
      }

      async function loadFallbackSingle(){
        setStatus("ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª­è¾¼ä¸­â€¦");
        const res = await fetch(FALLBACK_DATA_URL, {cache:"no-store"});
        if (!res.ok) throw new Error("JSONå–å¾—ã«å¤±æ•—: " + res.status);

        all = await res.json();

        // ã‚»ãƒ¬ã‚¯ãƒˆã¯å…¨ä»¶ã‹ã‚‰ä½œã‚‹ï¼ˆå°è¦æ¨¡ç”¨ï¼‰
        const allActresses = uniqSorted(all.flatMap(x => x.actresses || []));
        const allTags = uniqSorted(all.flatMap(x => x.tags || []));

        fillSelect(actress, allActresses, "å¥³å„ªï¼ˆã™ã¹ã¦ï¼‰");
        setAllTags(allTags);

        // äººæ°—ã‚¿ã‚°ã¯ç°¡æ˜“é›†è¨ˆ
        const counts = {};
        for (const w of all){
          // ã‚µãƒ³ãƒ—ãƒ«æœ‰ç„¡ãƒ•ã‚£ãƒ«ã‚¿
          if (onlyImg.checked && !(Number(w.sample_image_count || 0) > 0)) continue;
          if (onlyMov.checked && !w.has_sample_movie) continue;
          for (const t of (w.tags||[])){
            counts[t] = (counts[t]||0) + 1;
          }
        }
        const top = Object.entries(counts).sort((a,b)=> b[1]-a[1]).slice(0,30).map(([name,count])=>({name,count}));
        renderTopTags(top);

        const st = readStateFromUrl();
        applyStateToControls(st);

        setStatus(`èª­è¾¼å®Œäº†ï¼š${all.length}ä»¶`);
        applyFilters({resetRender:true});
      }

      async function init(){
        manifest = await tryLoadManifest();

        if (manifest){
          updateCounters();
          await loadAllByManifest(manifest);
        }else{
          await loadFallbackSingle();
        }

        updateCounters();
        setupInfiniteScroll();
      }

      // events
      q.addEventListener("input", () => applyFilters({resetRender:true}));
      actress.addEventListener("change", () => applyFilters({resetRender:true}));
      mode.addEventListener("change", () => applyFilters({resetRender:true}));
      sort.addEventListener("change", () => applyFilters({resetRender:true}));
      onlyImg.addEventListener("change", () => { updateToggleStyles(); applyFilters({resetRender:true}); });
      onlyMov.addEventListener("change", () => { updateToggleStyles(); applyFilters({resetRender:true}); });

      // ã‚¿ã‚°å…¥åŠ›ï¼šEnterã§è¿½åŠ 
      tagInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          const v = tagInput.value.trim();
          if (!v) return;
          addTag(v);
          tagInput.value = "";
          applyFilters({resetRender:true});
        }
      });

      reset.addEventListener("click", () => {
        q.value = "";
        actress.value = "";
        setSelectedTags([]);
        tagInput.value = "";
        mode.value = "or";
        sort.value = "new";
        onlyImg.checked = false;
        onlyMov.checked = false;
        updateToggleStyles();
        applyFilters({resetRender:true});
        q.focus();
      });

      loadMoreBtn.addEventListener("click", () => {
        renderMore();
      });

      init().catch(err => {
        results.innerHTML = `<div class="meta">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š${escapeHtml(err.message)}</div>`;
        setStatus("");
      });
    })();
  </script>
</body>
</html>
